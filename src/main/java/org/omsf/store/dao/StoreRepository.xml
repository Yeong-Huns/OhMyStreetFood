<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="org.omsf.store.dao.StoreRepository">
	
  	<resultMap id="storeResultMap" type="org.omsf.store.model.Store">
	    <id property="storeNo" column="STORENO"/>
	    <result property="storeName" column="STORENAME"/>
	    <result property="latitude" column="LATITUDE"/>
	    <result property="longitude" column="LONGITUDE"/>
	    <result property="address" column="ADDRESS"/>
	    <result property="introduce" column="INTRODUCE"/>
	    <result property="operatingDate" column="OPERATINGDATE"/>
	    <result property="operatingHours" column="OPERATINGHOURS"/>
	    <result property="totalReview" column="TOTALREVIEW"/>
	    <result property="totalRating" column="TOTALRATING"/>
	    <result property="likes" column="LIKES"/>
	    <result property="createdAt" column="CREATEDAT"/>
	    <result property="modifiedAt" column="MODIFIEDAT"/>
	    <result property="username" column="MEMBER_USERNAME"/>
	    <result property="picture" column="PICTURE"/>
	</resultMap>

<!--   <select id="getStoreByposition" resultType="org.omsf.store.model.Store"> -->
<!--   	<bind name="pattern" value="'%' + position + '%'" /> -->
<!--   	SELECT * FROM STORE WHERE ADDRESS LIKE #{pattern} -->
<!--   	SELECT -->
<!--   		STORENO AS "storeNo", -->
<!--   		STORENAME AS "storeName", -->
<!--   		LATITUDE AS "latitude", -->
<!--   		LONGITUDE AS "longitude", -->
<!--   		ADDRESS AS "address", -->
<!--   		INTRODUCE AS "introduce", -->
<!--   		OPERATINGDATE AS "operatingDate", -->
<!--   		OPERATINGHOURS AS "operatingHours", -->
<!--   		TOTALREVIEW AS "totalReview", -->
<!--   		TOTALRATING AS "totalRating", -->
<!--   		LIKES AS "likes", -->
<!--   		CREATEDAT AS "createdAt", -->
<!--   		MODIFIEDAT AS "modifiedAt", -->
<!--   		MEMBER_USERNAME AS "username", -->
<!--   		PICTURE AS "picture" -->
<!--   	FROM STORE -->
<!--   	WHERE ADDRESS LIKE #{pattern} -->
<!--   </select> -->
  
  <insert id="createStore" parameterType="org.omsf.store.model.Store">
        INSERT INTO store
        (
        	storeNo,
            storeName,
            latitude,
            longitude,
            address,
            createdAt,
            <trim suffixOverrides=",">
                MEMBER_USERNAME,
                <if test="picture != null">picture,</if>
                <if test="introduce != null">introduce,</if>
                <if test="operatingDate != null">operatingDate,</if>
                <if test="operatingHours != null">operatingHours,</if>
                <if test="totalReview != null">totalReview,</if>
                <if test="totalRating != null">totalRating,</if>
                <if test="likes != null">likes,</if>
            </trim>
        )
        VALUES
        (
        	STORE_SEQ.NEXTVAL,
            #{storeName},
            #{latitude},
            #{longitude},
            #{address},
            sysdate,
            <trim suffixOverrides=",">
                #{username},
                <if test="picture != null">#{picture},</if> 
                <if test="introduce != null">#{introduce},</if>
                <if test="operatingDate != null">#{operatingDate},</if>
                <if test="operatingHours != null">#{operatingHours},</if>
                <if test="totalReview != null">#{totalReview},</if>
                <if test="totalRating != null">#{totalRating},</if>
                <if test="likes != null">#{likes},</if>
            </trim>
        )
        <selectKey keyProperty="storeNo" resultType="int" order="AFTER">
       		SELECT STORE_SEQ.CURRVAL FROM DUAL
  		</selectKey>
    </insert>	
    
	<insert id="createPhoto" parameterType="org.omsf.store.model.Photo">
    INSERT INTO PHOTO 
    (	
    	PHOTONO,
        CONTENTTYPE,
        FILESIZE,
        PICTURE,
        CREATEDAT,
        STORE_STORENO
    )
    VALUES
    (	
    	PHOTO_SEQ.NEXTVAL,
        #{contentType},
        #{fileSize},
        #{picture},
        sysdate,
        #{storeNo}
    )
   		 <selectKey keyProperty="photoNo" resultType="int" order="AFTER">
       		SELECT PHOTO_SEQ.CURRVAL FROM DUAL
  		</selectKey>
	</insert>
	<update id="deletePhoto" parameterType="int">
		DELETE PHOTO WHERE PHOTO = #{PhotoNo}
	</update>
	
	<update id="updateStore">
	    UPDATE STORE
	    SET
	        STORENAME = #{storeName},
	        LATITUDE = #{latitude},
	        LONGITUDE = #{longitude},
	        ADDRESS = #{address},
	        INTRODUCE = #{introduce},
	        OPERATINGDATE = #{operatingDate},
	        OPERATINGHOURS = #{operatingHours},
	        MODIFIEDAT = sysdate,
	        PICTURE = #{picture, jdbcType=NUMERIC}
	    WHERE
	        STORENO = #{storeNo}
	</update>
<!-- 	<update id="deleteStore" parameterType="int"> -->
<!-- 	      DELETE FROM store -->
<!--     		WHERE storeNo = #{storeNo} -->
<!-- 	</update> -->
	
	<update id="updateTotalReviewAndRating">
	    UPDATE STORE
	     SET
	        TOTALREVIEW = #{totalReview},
	        TOTALRATING = #{totalRating}
	     WHERE
	        STORENO = #{storeNo}
	</update>
	<update id="updateLikes">
	    UPDATE STORE
	     SET
	        LIKES = #{likes},
	     WHERE
	        STORENO = #{storeNo}
	</update>
	
	<select id="getStoreByposition" parameterType="String" resultMap="storeResultMap">
		SELECT *
		FROM STORE
		WHERE ADDRESS LIKE #{address}
	</select>
	<select id="selectAllStore" resultMap="storeResultMap">
		SELECT *
		FROM STORE
	</select>
	<select id="getStoreList" resultMap="storeResultMap">
	    SELECT *
	    FROM STORE
	    WHERE 1=1
	    <if test="searchType != null and searchType != '' and keyword != null and keyword != ''">
	            AND ${searchType} LIKE '%' || #{keyword} || '%'
	    </if>
	    <if test="orderType != null and orderType != ''">
	        ORDER BY ${orderType} ${sortOrder}
	    </if>
	    OFFSET #{startRow} ROWS FETCH NEXT #{sizePerPage} ROWS ONLY
	</select>
	
	<!-- jaeeun -->
	
	<select id="getAllStores" resultMap="storeResultMap">
		SELECT * FROM STORE
	</select>

	<select id="getStoreByNo" parameterType="int" resultMap="storeResultMap">
		SELECT * FROM STORE WHERE STORENO = #{storeNo}
	</select>
	
	<!-- yunbin -->
	<select id="getStoreNameByStoreNo" resultType="String">
		SELECT storename AS storeName FROM WHERE STORENO = #{storeNo}
	</select>
	<delete id="deleteStore">
		DELETE FROM store WHERE storeno=#{storeNo} 
	</delete>
</mapper>